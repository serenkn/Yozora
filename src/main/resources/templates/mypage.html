<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">

<head>
    <meta charset="UTF-8">
    <title>„Éû„Ç§„Éö„Éº„Ç∏</title>
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js" defer></script>
    <script th:src="@{/js/post.js}" defer></script>
    <script>
        window.addEventListener("pageshow", function (event) {
            if (event.persisted) {
                location.reload();
            }
        });
    </script>
</head>

<body>
    <main>
        <!-- „Éó„É≠„Éï„Ç£„Éº„É´„Éò„ÉÉ„ÉÄ„Éº -->
        <header class="profile-header">
            <!-- „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥ -->
            <div class="logout-wrapper">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="link-button">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </form>
            </div>

            <!-- „Éó„É≠„Éï„Ç£„Éº„É´„Ç®„É™„Ç¢ -->
            <div class="profile-horizontal">
                <!-- „Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè -->
                <div class="profile-image">
                    <img th:src="${user.profileImage}" alt="„Éó„É≠„Éï„Ç£„Éº„É´ÁîªÂÉè">
                </div>

                <!-- „Éó„É≠„Éï„Ç£„Éº„É´ÊÉÖÂ†± -->
                <div class="profile-info">
                    <p class="user-name" th:text="${user.userName}">„É¶„Éº„Ç∂„ÉºÂêç</p>
                    <div class="profile-stats">
                        <div><strong th:text="${postList != null ? postList.size() : 0}">0</strong> ÊäïÁ®ø</div>
                        <div><strong th:text="${followerCount}">0</strong> „Éï„Ç©„É≠„ÉØ„Éº</div>
                        <div><strong th:text="${followCount}">0</strong> „Éï„Ç©„É≠„Éº‰∏≠</div>
                    </div>
                    <div class="profile-actions">
                        <a th:href="@{/userEdit}" class="edit-btn">„Éó„É≠„Éï„Ç£„Éº„É´„ÇíÁ∑®ÈõÜ</a>
                    </div>
                </div>
            </div>
        </header>

        <input type="hidden" id="loginUserId" th:value="${user.id}">

        <!-- ÊäïÁ®ø‰∏ÄË¶ß -->
        <section class="post-list">
            <!-- ÊäïÁ®ø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆË°®Á§∫ -->
            <div class="no-posts" th:if="${postList == null or postList.isEmpty()}">
                <p>ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>

            <!-- ÊäïÁ®ø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆË°®Á§∫ -->
            <div class="posts-container" th:if="${postList != null and !postList.isEmpty()}">
                <div th:each="post : ${postList}" class="post-item">

                    <!-- ÊäïÁ®øËÄÖÊÉÖÂ†± -->
                    <div class="user-info">
                        <img th:src="@{${user.profileImage}}" class="user-icon" alt="„Ç¢„Ç§„Ç≥„É≥">
                        <span th:text="${user.userName}" class="user-name"></span>
                    </div>

                    <!-- „Çø„Ç§„Éà„É´ -->
                    <p class="post-title" th:text="${post.title}"></p>

                    <!-- ÁîªÂÉèË§áÊï∞ÊûöË°®Á§∫ -->
                    <div class="swiper post-carousel" th:if="${post.imageUrls != null}">
                        <div class="swiper-wrapper">
                            <div class="swiper-slide" th:each="img : ${post.imageUrls}">
                                <img th:src="${img}" alt="ÊäïÁ®øÁîªÂÉè" class="carousel-image">
                            </div>
                        </div>
                        <div class="swiper-pagination"></div>
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-button-next"></div>
                    </div>

                    <div class="post-meta">
                        <!-- ÊäïÁ®øÊó•ÊôÇ -->
                        <p class="post-time date-time" th:text="${post.createdAt}"></p>

                        <div class="post-actions">
                            <!-- „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥ -->
                            <button class="likeBtn" th:data-post-id="${post.id}" th:data-liked="${post.liked}"
                                th:onclick="|toggleLike(this)|">
                                <span th:if="${post.liked}">‚≠ê</span>
                                <span th:unless="${post.liked}">‚òÖ</span>
                                <span id="like-count" th:text="${post.likeCount}">0</span>
                            </button>

                            <!-- „Ç≥„É°„É≥„ÉàÊï∞Ôºà„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´Ôºâ -->
                            <div class="commentBtn" th:data-post-id="${post.id}" th:data-count="${post.commentCount}"
                                onclick="openCommentModal(this)">
                                üí¨<span th:text="${post.commentCount}">0</span>
                            </div>

                            <!-- ÂêÑÊäïÁ®ø„ÅÆ„Ç≥„É°„É≥„Éà„É™„Çπ„Éà„Çí JSON Âüã„ÇÅËæº„ÅøÔºàÂêå„Åò„Ç´„Éº„ÉâÂÜÖ„ÅßOKÔºâ -->
                            <script type="application/json" th:id="|comments-${post.id}|"
                                th:inline="javascript">/*[[${post.commentList}]]*/</script>

                            <!-- „É´„Éº„Éà„Éú„Çø„É≥ -->
                            <button type="button" class="route-btn"
                                th:if="${post.latitude != null and post.longitude != null}"
                                th:onclick="|openGoogleMapsRoute(${post.latitude}, ${post.longitude})|">
                                üìç„É´„Éº„Éà
                            </button>
                        </div>
                    </div>

                    <!-- Êú¨Êñá -->
                    <p class="post-text" th:text="${post.text}"></p>

                    <!-- ‰ΩèÊâÄ -->
                    <p class="post-address" th:text="${post.address}"></p>

                    <!-- Ë©≥Á¥∞„Éö„Éº„Ç∏„Å∏ -->
                    <form action="/post" class="detail-link">
                        <input type="hidden" name="id" th:value="${post.id}"></input>
                        <button type="submit">Ë©≥Á¥∞„ÅØ„Åì„Å°„Çâ„Å∏</button>
                    </form>

                    <!-- Á∑®ÈõÜ„ÉªÂâäÈô§„Éú„Çø„É≥ -->
                    <div class="edit-delete">
                        <a th:href="@{/post/edit/{id}(id=${post.id})}" class="edit-btn">Á∑®ÈõÜ</a>
                        <form th:action="@{/post/delete}" method="post" onsubmit="return confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü');">
                            <input type="hidden" name="id" th:value="${post.id}">
                            <input type="submit" value="ÂâäÈô§" class="delete-btn">
                        </form>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„É¢„Éº„ÉÄ„É´ -->
    <div id="commentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="comment-count">üí¨ „Ç≥„É°„É≥„Éà <span id="cm-count">0</span>‰ª∂</span>
                <button type="button" class="modal-close" onclick="closeCommentModal()">‚úï</button>
            </div>

            <div id="cm-list" class="comment-list"></div>

            <form th:action="@{/comment/add}" method="post" class="comment-form">
                <input type="hidden" name="postId" id="cm-postId">
                <input type="text" name="text" placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ" required>
                <button type="submit">ÈÄÅ‰ø°</button>
            </form>
        </div>
    </div>

    <!-- „Ç≥„É°„É≥„ÉàÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="editModal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <span>Á∑®ÈõÜ</span>
                <button type="button" class="modal-close" onclick="closeEditModal()">‚úï</button>
            </div>
            <form method="post" action="/comment/edit">
                <input type="hidden" name="id" id="editCommentId">
                <textarea name="text" id="editCommentText"></textarea>
                <button type="submit" class="edit-submit">Êõ¥Êñ∞</button>
            </form>
        </div>
    </div>

    <!-- „Éï„ÉÉ„Çø„Éº -->
    <div th:replace="~{fragments/footer :: footer}"></div>

</body>

</html>